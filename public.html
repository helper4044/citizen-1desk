<!DOCTYPE html>
<html>
<head>
<title>CitizenDesk – Public</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body{margin:0;font-family:Arial;background:#0f2027;color:#fff}
header{background:#081821;padding:14px;text-align:center;font-weight:bold}
#map{height:300px;margin:20px;border-radius:12px;border:2px solid #00ffcc}
.card{max-width:600px;margin:20px auto;background:#122733;padding:16px;border-radius:12px;border:2px solid #00ffcc}
input,textarea,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none;background:#081821;color:#fff}
button{padding:12px;border-radius:8px;border:0;margin-top:12px;font-weight:bold}
.submit{background:#00ffcc;color:#000}
.logout{background:transparent;color:#00ffcc;border:2px solid #00ffcc}

/* FULL SCREEN FEEDBACK */
#feedbackBox{
  position:fixed;inset:0;background:rgba(0,0,0,.95);
  display:none;justify-content:center;align-items:center;z-index:99999
}
.fb-inner{background:#122733;padding:20px;border-radius:14px;width:300px;text-align:center}
</style>
</head>

<body>

<header>Public Complaint</header>

<div id="map"></div>

<div class="card">
  <b>Type of Issue</b>
  <input id="issue">

  <b>Complaint Priority</b>
  <select id="severity">
    <option>Low – Minor Issue</option>
    <option>Medium – Needs Attention</option>
    <option>High – Emergency</option>
  </select>

  <b>Problem Details</b>
  <textarea id="desc"></textarea>

  <b>Upload Photo</b>
  <input type="file" id="img">

  <button class="submit" onclick="submit()">Submit</button>
  <button class="logout" onclick="location.href='index.html'">Logout</button>
</div>

<div id="feedbackBox">
  <div class="fb-inner">
    <h3>Rate Your Experience</h3>
    <select>
      <option>5 - Excellent</option>
      <option>4 - Good</option>
      <option>3 - Average</option>
      <option>2 - Poor</option>
      <option>1 - Very Bad</option>
    </select>
    <textarea placeholder="Optional feedback"></textarea><br><br>
    <button onclick="finish()">Submit</button>
    <button onclick="finish()">Skip</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const CLOUD_NAME="drscsdi5m";
const UPLOAD_PRESET="public_upload";
const BIN_ID="69149419ae596e708f54b77e";
const API_KEY="$2a$10$M82XOQ0SzJJkyIbSqmB.N.P3E4SU23ePZ5D2QBby.ZbLAlwgBK3c6";

let map=L.map('map').setView([30.3165,78.0322],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let selectedLatLng=null, marker=null;

map.on('click',e=>{
  selectedLatLng=e.latlng;
  if(marker) map.removeLayer(marker);
  marker=L.marker(e.latlng).addTo(map);
});

async function submit(){
  if(!selectedLatLng) return alert("Select location on map");
  const issueVal=issue.value.trim();
  const descVal=desc.value.trim();
  if(!issueVal||!descVal) return alert("Fill all fields");

  const file=img.files[0];
  let photoUrl="";

  if(file){
    const fd=new FormData();
    fd.append("file",file);
    fd.append("upload_preset",UPLOAD_PRESET);

    const up=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{
      method:"POST",body:fd
    });

    const upData=await up.json();
    photoUrl=upData.secure_url;
  }

  const get=await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{
    headers:{"X-Master-Key":API_KEY}
  });

  const data=await get.json();
  const list=data.record?.complaints || [];

  list.push({
    issue:issueVal,
    severity:severity.value,
    desc:descVal,
    lat:selectedLatLng.lat,
    lng:selectedLatLng.lng,
    image:photoUrl,
    status:"Not Yet Taken"
  });

  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json","X-Master-Key":API_KEY},
    body:JSON.stringify({complaints:list})
  });

  feedbackBox.style.display="flex";
}

function finish(){
  location.href="public-status.html";
}
</script>

</body>
</html>